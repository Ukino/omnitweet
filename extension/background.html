<html>
  <head>
  <!-- Include OAuth JavaScript files -->
  <script type="text/javascript" src="config.js"></script>
  <script type="text/javascript" src="libraries/chrome_ex_oauthsimple.js"></script>
  <script type="text/javascript" src="libraries/chrome_ex_oauth.js"></script>
  <script type="text/javascript" src="libraries/twitter-text.js"></script>
  <script type="text/javascript" src="javascript/utilities.js"></script>
  <script type="text/javascript" src="javascript/status.js"></script>
  <script type="text/javascript" src="javascript/direct_message.js"></script>
  <script type="text/javascript" src="javascript/notice.js"></script>
  <script type="text/javascript" src="javascript/twitter.js"></script>
  <script type="text/javascript" src="javascript/poll.js"></script>
  <script>
// Is users location currently being updateed.
var currentLocationRequest = false;
var lastTabID = 0;
// Build OAuth stuff.
var oauth = ChromeExOAuth.initBackgroundPage({
  request_url: 'https://api.twitter.com/oauth/request_token',
  authorize_url: 'https://api.twitter.com/oauth/authorize',
  access_url: 'https://api.twitter.com/oauth/access_token',
  // Make sure to include consumer key and secret from http://dev.twitter.com/apps.
  consumer_key: Config.consumer_key,
  consumer_secret: Config.consumer_secret,
  scope: '',
  app_name: 'OmniTweet for Chrome'
});

// Get the place locations saved in localStorage. Will get new location if older then 15 min or true included.
function getLocations(force) {
  if (localStorage.geo_enabled == 'disabled') {
    return false;
  }
  var d = new Date();
  time = Math.floor(d.getTime() / 1000);
  // Check if location is old  not existant or forced update.
  if(force || !localStorage.geo_touched || parseInt(localStorage.geo_touched) + 15 * 60 <= time){
    updateLocation();
    return false;
  }
  return localStorage.places ? JSON.parse(localStorage.places) : false;
}

// Get current browser location and exchange for 5 neighborhoods from Twitter.
function updateLocation() {
  // Cancel if locations already being fetched.
  if (currentLocationRequest || localStorage.geo_enabled == 'disabled') {
    return false;
  }
  currentLocationRequest = true;
  console.log('Updating location...');
  // Get current location from browser.
  navigator.geolocation.getCurrentPosition(function(position) {
    if(!position) {
      return false;
    }
    // Callback for places request
    var callback = function(result) {
      var d = new Date();
      if (200 == result.status && result.data.result.places.length){
        var places = [];
        for(var place in result.data.result.places) {
          places.push({
            name: result.data.result.places[place].name,
            id: result.data.result.places[place].id
          });
        }
        // Cache location locally.
        localStorage.places = JSON.stringify(places);
        localStorage.latitude = position.coords.latitude;
        localStorage.longitude = position.coords.longitude;
      } else {
        time = Math.floor(d.getTime() / 1000);
        if(!localStorage.geo_touched || parseInt(localStorage.geo_touched) + 15 * 60 <= time){
          infoBar();
        }
      }
      localStorage.geo_touched = Math.floor(d.getTime() / 1000);
      currentLocationRequest = false;
      console.log('Location updated :)');
    };
    // Location parameters
    var parameters = {
      lat: position.coords.latitude,
      long: position.coords.longitude,
      max_results: 5
    };
    // Make OAuth request to Twitter for places.
    Twitter.get('geo/search', callback, parameters);
  });
}

// OmniBox selected OmnitTweet so update location.
chrome.experimental.omnibox.onInputStarted.addListener(
  function() {
    modifyPageAction(140);
    getLocations();
  });

// OmniBox cancelled so remove character counter  
chrome.experimental.omnibox.onInputCancelled.addListener(
  function() {
    // Remove page action if it exists.
    if(lastTabID) {
      chrome.pageAction.hide(lastTabID);
      lastTabID = 0;    
    }
  }
);

// Suggest locations to user in OmniBox.
chrome.experimental.omnibox.onInputChanged.addListener(
  function(text, suggest) {
    if ('' == text) {
      modifyPageAction(140);
      return;
    }
    modifyPageAction(140 - countCharacters(text));
    var as = localStorage.screen_name ? ' as @' + localStorage.screen_name : '';
    var places = getLocations();
    var suggestions = [{content: text, description: chrome.i18n.getMessage("verbTweet") + " " + text + as}];
    // Only suggets locations if the are available.
    if(places) {
      for(var place in places) {
        suggestions.push({
          content: JSON.stringify({status: text, place_id: places[place].id}),
          description: chrome.i18n.getMessage("verbTweet") + " " + text + " from " + places[place].name + as,
          descriptionStyles: [
            chrome.experimental.omnibox.styleMatch(0),
            chrome.experimental.omnibox.styleNone(6),
            chrome.experimental.omnibox.styleMatch(text.length + 8)
          ]
        });     
      }
    }    
    suggest(suggestions);
  }
);

// User hit enter so post tweet.
chrome.experimental.omnibox.onInputEntered.addListener(
  function(content) {
    // Vars for updating users status.
    var status;
    var place_id;
    // Remove page action if it exists
    if(lastTabID) {
      chrome.pageAction.hide(lastTabID);
      lastTabID = 0;    
    }
    // Check if users hit enter in omnibar or on a dropdown suggestion.
    if (content.substring(0, 10) == '{"status":') {
      content = JSON.parse(content);
      place_id = content.place_id ? content.place_id : false;
      status = content.status;
    } else {
      status = content;
      place_id = false;
    }
    Twitter.update(status, {place_id: place_id});
  }
);

// Change the count value of the page action.
function modifyPageAction(count) {
  chrome.tabs.getSelected(null, function(tab) {
    lastTabID = tab.id;
    chrome.pageAction.show(lastTabID);
    chrome.pageAction.setIcon({imageData: drawCount(count), tabId: lastTabID});
  });
}

function infoBar(text) {
  chrome.tabs.getSelected(null, function(tab) {
    lastInfoBarTabID = tab.id;
    chrome.experimental.infobars.show({tabId: lastInfoBarTabID, path: 'infobar.html?text=' + text}, function(window){console.log(window)});
  });
}

// Draw the available character count page action.
function drawCount(count) {
  var canvas = document.getElementById("canvas");
  var context = canvas.getContext("2d");
  context.clearRect(0, 0, canvas.width, canvas.height);
  context.textAlign = "center";
  context.fillStyle = '#CCCCCC';
  context.textBaseline = "middle";
  context.font = "bold 12px Helvetica Neue";
  if (count < 10) {
    context.fillStyle = '#D40D12';
  } else if(count < 20) {
    context.fillStyle = '#5C0002';
  }
  context.fillText(count, 9.5, 10);
  return context.getImageData(0, 0, 19, 19);
}

function install() {
  Twitter.verify_credentials({install: true});
  Twitter.direct_messages({silent: true});
  Twitter.mentions({silent: true});
  updateLocation();
  localStorage.installed = 'true';
  Poll.start();
  console.log('OmiTweet installed successfully!');
}

chrome.extension.onRequest.addListener(
  function(request, sender, sendResponse) {
    switch (request.action){
      case 'install':
        install();
      case 'oauth':
        oauth.authorize(install);
    }
  }
);

function init() {
  if (localStorage.installed != 'true') {
    oauth.authorize(install);
  } else {
    Poll.start();
  }
}

init();
  </script>
  </head>
  <body>
    <canvas id='canvas' width='19' height='19'></canvas>
  </body>
</html>