<html>
  <head>
  <!-- Include OAuth JavaScript files -->
  <script type="text/javascript" src="lib/chrome_ex_oauthsimple.js"></script>
  <script type="text/javascript" src="lib/chrome_ex_oauth.js"></script>
  <script type="text/javascript" src="lib/twitter-text.js"></script>
  <script type="text/javascript" src="status.js"></script>
  <script>
// Is users location currently being updateed.
var currentLocationRequest = false;
var lastTabID = 0;
// Build OAuth stuff.
var oauth = ChromeExOAuth.initBackgroundPage({
  request_url: 'https://api.twitter.com/oauth/request_token',
  authorize_url: 'https://api.twitter.com/oauth/authorize',
  access_url: 'https://api.twitter.com/oauth/access_token',
  // Make sure to include consumer key and secret from http://dev.twitter.com/apps.
  consumer_key: '',
  consumer_secret: '',
  scope: '',
  app_name: 'OmniTweet for Chrome'
});

// If there is no OAuth user tokens start the OAuth process
if (!oauth.hasToken()) {
  oauth.authorize(onAuthorized);
}

// Get the place locations saved in localStorage. Will get new location if older then 15 min or true included.
function getLocations(force) {
  var d = new Date();
  time = Math.floor(d.getTime() / 1000);
  // Check if location is old  not existant or forced update.
  if(force || !localStorage.geo_touched || parseInt(localStorage.geo_touched) + 15 * 60 <= time){
    updateLocation();
    return false;
  }
  return localStorage.places ? JSON.parse(localStorage.places) : false;
}

// Get current browser location and exchange for 5 neighborhoods from Twitter.
function updateLocation() {
  // Cancel if locations already being fetched.
  if (currentLocationRequest) {
    return false;
  }
  currentLocationRequest = true;
  console.log('Updating location...');
  // Get current location from browser.
  navigator.geolocation.getCurrentPosition(function(position) {
    if(!position) {
      return false;
    }
    // Set up vars for OAuth call to Twitter
    var url = 'https://api.twitter.com/1/geo/search.json';
    var callback = function(data) {
      if (response = JSON.parse(data)){
        var places = [];
        for(var place in response.result.places) {
          places.push({
            name: response.result.places[place].name,
            id: response.result.places[place].id
          });
        }
        // Cache location locally.
        localStorage.places = JSON.stringify(places);
        localStorage.latitude = position.coords.latitude;
        localStorage.longitude = position.coords.longitude;
        var d = new Date();
        localStorage.geo_touched = Math.floor(d.getTime() / 1000);
        currentLocationRequest = false;
      }
    };
    var parameters = {
      method: 'GET',
      parameters: {
        lat: position.coords.latitude,
        long: position.coords.longitude,
        max_results: 5
      }
    };
    // Make OAuth request to Twitter for places.
    oauth.sendSignedRequest(url, callback, parameters);
  });
}

// User succesfully authorized Twitter
function onAuthorized() {
  console.log('Twitter authorization successful!');
  updateLocation();
}

// OmniBox selected OmnitTweet so update location.
chrome.experimental.omnibox.onInputStarted.addListener(
  function() {
    modifyPageAction(140);
    getLocations();
  });

// OmniBox cancelled so remove character counter  
chrome.experimental.omnibox.onInputCancelled.addListener(
  function() {
    // Remove page action if it exists.
    if(lastTabID) {
      chrome.pageAction.hide(lastTabID);
      lastTabID = 0;    
    }
  }
);

// Suggest locations to user in OmniBox.
chrome.experimental.omnibox.onInputChanged.addListener(
  function(text, suggest) {
    if ('' == text) {
      modifyPageAction(140);
      return;
    }
    modifyPageAction(140 - countCharacters(text));
    var as = localStorage.screen_name ? ' as @' + localStorage.screen_name : '';
    var places = getLocations();
    var suggestions = [{content: text, description: chrome.i18n.getMessage("verbTweet") + " " + text + as}];
    // Only suggets locations if the are available.
    if(places) {
      for(var place in places) {
        suggestions.push({
          content: JSON.stringify({status: text, place_id: places[place].id}),
          description: chrome.i18n.getMessage("verbTweet") + " " + text + " from " + places[place].name + as,
          descriptionStyles: [
            chrome.experimental.omnibox.styleMatch(0),
            chrome.experimental.omnibox.styleNone(6),
            chrome.experimental.omnibox.styleMatch(text.length + 8)
          ]
        });     
      }
    }    
    suggest(suggestions);
  }
);

// User hit enter so post tweet.
chrome.experimental.omnibox.onInputEntered.addListener(
  function(content) {
    // Remove page action if it exists
    if(lastTabID) {
      chrome.pageAction.hide(lastTabID);
      lastTabID = 0;    
    }
    // Vars for status create call to Twitter.
    var status;
    var place_id;
    var url = 'https://api.twitter.com/1/statuses/update.json';
    if (content.substring(0, 10) == '{"status":') {
      content = JSON.parse(content);
      place_id = content.place_id ? content.place_id : false;
      status = content.status;
    } else {
      status = content;
    }
    // Show a desktop notification when a status is created.
    var callback = function(data) {
      if (response = JSON.parse(data)){
        Status.save(response);
        var notification = webkitNotifications.createHTMLNotification('status.html?id=' + response.id);
        notification.show();
        !localStorage.screen_name ? localStorage.screen_name = response.user.screen_name : false;
        console.log('Tweet posted');
      }
    }
    var parameters = {
      method: 'POST',
      parameters: {
        status: status
      }
    }
    if(content.place_id) { 
      parameters.parameters.place_id = place_id;
    }
    // Make OAuth call to post tweet.
    oauth.sendSignedRequest(url, callback, parameters);
  }
);

// Count characters and count each URL as 20 characters to match what t.co will be.
function countCharacters(string) {
  count = string.length;
  urls = TwitterText.extract_urls(string);
  if (urls.length != 0) {
    for (var url in urls) {
      count = count + (20 - urls[url].length);
    }
  }
  return count;
}

// Change the count value of the page action.
function modifyPageAction(count) {
  chrome.tabs.getSelected(null, function(tab) {
    lastTabID = tab.id;
    chrome.pageAction.show(lastTabID);
    chrome.pageAction.setIcon({imageData: drawCount(count), tabId: lastTabID});
  });
}

// Draw the available character count page action.
function drawCount(count) {
  var canvas = document.getElementById("canvas");
  var context = canvas.getContext("2d");
  context.clearRect(0, 0, canvas.width, canvas.height);
  context.textAlign = "center";
  context.fillStyle = '#CCCCCC';
  context.textBaseline = "middle";
  context.font = "bold 12px Helvetica Neue";
  if (count < 10) {
    context.fillStyle = '#D40D12';
  } else if(count < 20) {
    context.fillStyle = '#5C0002';
  }
  context.fillText(count, 9.5, 10);
  return context.getImageData(0, 0, 19, 19);
}
  </script>
  </head>
  <body>
    <canvas id='canvas' width='19' height='19'></canvas>
  </body>
</html>